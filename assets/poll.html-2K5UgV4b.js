import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as a,e as t}from"./app-jdLxCr9I.js";const p={},e=t(`<h1 id="poll" tabindex="-1"><a class="header-anchor" href="#poll" aria-hidden="true">#</a> poll</h1><p>本质上和select没有区别,只是没了最大文件描述符的限制</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>select.poll()</td><td>返回poll对象,用来注册文件描述符和事件</td></tr><tr><td>poll.register(fd[, eventmask])</td><td>fd是整数,可以是fileno()方法返回;eventmask:事件类型</td></tr><tr><td>poll.modify(fd, eventmask)</td><td>更新注册信息</td></tr><tr><td>poll.unregister(fd)</td><td>注销fd</td></tr><tr><td>poll.poll([timeout])</td><td>检测注册后的fd,返回[(fd,event),()...];如果返回空说明超时,且没有事件发生,否则阻塞</td></tr></tbody></table><table><thead><tr><th>事件类型</th><th>描述</th></tr></thead><tbody><tr><td>POLLIN</td><td>读就绪</td></tr><tr><td>POLLOUT</td><td>写就绪</td></tr><tr><td>POLLHUP</td><td>挂起</td></tr><tr><td>POLLPRT</td><td>有数据紧急读取</td></tr><tr><td>POLLERR</td><td>某些错误情况出现</td></tr><tr><td>POLLNVAL</td><td>无效请求:描述无法打开</td></tr></tbody></table><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> select<span class="token punctuation">,</span> socket

response <span class="token operator">=</span> <span class="token string">b&quot;hello world&quot;</span>

serversocket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
serversocket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
serversocket<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
serversocket<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
serversocket<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

poll <span class="token operator">=</span> select<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
poll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>serversocket<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span>  <span class="token comment"># 监听数据读取事件</span>

connections <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> fd<span class="token punctuation">,</span> event <span class="token keyword">in</span> poll<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> event <span class="token operator">==</span> select<span class="token punctuation">.</span>POLLIN<span class="token punctuation">:</span> <span class="token comment"># 读就绪</span>
            <span class="token keyword">if</span> fd <span class="token operator">==</span> serversocket<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 注意这个是监听描述符,不是连接文件描述符,这个是用来判断有没有连接进来</span>
                con<span class="token punctuation">,</span> addr <span class="token operator">=</span> serversocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
                poll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>con<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span> <span class="token comment"># 这个是用来监听连接的文件描述符,服务端和客户端创建连接后,会使用新的文件描述符</span>
                connections<span class="token punctuation">[</span>con<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> con  <span class="token comment"># 将连接描述符放入字典管理</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                con <span class="token operator">=</span> connections<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>  <span class="token comment"># 获取连接的fd,和连接对象</span>
                data <span class="token operator">=</span> con<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> data<span class="token punctuation">:</span>  <span class="token comment"># 如果获得客户端发来的数据,就将连接的注册事件更改为写就绪,进入到下面的elif</span>
                    poll<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>con<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLOUT<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> event <span class="token operator">==</span> select<span class="token punctuation">.</span>POLLOUT<span class="token punctuation">:</span>  <span class="token comment"># 监听到写就绪事件,就发送消息</span>
            con <span class="token operator">=</span> connections<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
            con<span class="token punctuation">.</span>send<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
            poll<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>con<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 注销该连接,既从连接池里删除</span>
            con<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参考: https://www.cnblogs.com/qianyuliang/p/6551553.html</p>`,6),o=[e];function c(l,u){return s(),a("div",null,o)}const k=n(p,[["render",c],["__file","poll.html.vue"]]);export{k as default};
