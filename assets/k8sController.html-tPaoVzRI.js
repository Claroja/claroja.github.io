import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as a,c as s,e}from"./app-0JgdiRQ-.js";const l={},t=e(`<h1 id="process-pool" tabindex="-1"><a class="header-anchor" href="#process-pool" aria-hidden="true">#</a> process_pool</h1><h2 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> controller</h2><p>管理pod的中间层, 只需操作controller我们需要怎样的pod, 它就会自动创建并帮忙维护, 比如出现故障会进行重启</p><ul><li>ReplicaSet: 指定数量, 数量变更, 镜像版本变更</li><li>Deployment: 继承ReplicaSet, 并多加滚动升级和版本回退</li><li>Horizontal Pod Autoscaler: 根据负载自动扩容</li><li>DaemonSet: 在指定Node运行一个副本, 用于守护进程</li><li>Job: 完成任务立即退出, 用于执行一次性任务</li><li>Cronjob: 周期性执行</li><li>StatefulSet: 有状态应用</li></ul><h3 id="replicaset-rs" tabindex="-1"><a class="header-anchor" href="#replicaset-rs" aria-hidden="true">#</a> ReplicaSet(RS)</h3><ul><li>创建 <code>kubectl create -f [YAML_PATH]</code></li><li>删除 <ul><li>删除controller和pods <code>kubectl delete rs [NAME]</code></li><li>只删除controller<code>kubectl delete rs [NAME] --cascade=false</code></li></ul></li><li>保证一定数量的pod能够正常运行, 支持扩缩容 通过<code>spec.replicas</code>来控制 <code>kubectl edit rs NAME</code> 弹出yml文件修改 <code>kubectl scale rs NAME --replicas=2</code> 命令行指定</li><li>版本镜像升级 通过<code>spec.template.spec.image</code>来控制 <code>kubectl edit rs NAME</code> 弹出yml文件修改 <code>kubectl set image rs NAME --image=[NAME]</code> 弹出yml文件修改</li></ul><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">piVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>rc
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>rc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>rc
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>rc
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="deployment" tabindex="-1"><a class="header-anchor" href="#deployment" aria-hidden="true">#</a> Deployment</h3><ul><li>继承ReplicaSet所有功能</li><li>支持发布的停止和继续</li><li>支持版本的更新和回退</li></ul><p>当使用<code>kubectl create deplpyment</code>创建时, 可以查看pods信息和rs信息</p><ul><li>pod命名方式: deployment-rs(随机串)-pod(随机串) <code>kubectl get deployments</code>(查看控制器)</li><li>rs命名方式: deployment-rs(随机串) <code>kubectl get rs</code>(查看副本)</li><li>deployment命名方式: deployment <code>kubectl get pods</code>(查看控制器的pods)</li></ul><h4 id="基础操作" tabindex="-1"><a class="header-anchor" href="#基础操作" aria-hidden="true">#</a> 基础操作</h4><h5 id="命令行控制" tabindex="-1"><a class="header-anchor" href="#命令行控制" aria-hidden="true">#</a> 命令行控制</h5><ul><li>创建控制器 <code>kubectl run deployment [NAME] --image [NAME] --port [NUM] --replicas [NUM]</code> image: 使用的镜像 port: 端口 replicas: 副本数量, 一个controller包含多个pod, 使用label来建立关系, 默认是 <code>run:DEPLOYMENT_NAME</code></li><li>查看容器 <code>kubectl get deployment</code></li><li>详细描述 <code>kubectl describe deployment</code></li><li>删除controller <code>kubectl delete deployment</code></li></ul><h5 id="配置文件控制" tabindex="-1"><a class="header-anchor" href="#配置文件控制" aria-hidden="true">#</a> 配置文件控制</h5><p><code>kubectl create/apply -f [YAML_PATH]</code> 创建了一个ReplicaSet负责启动三个nginx Pods：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 定义controller基本信息</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment <span class="token comment"># controller 唯一名称</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 定义controller 内容</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 3个pod副本</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># controller查找管理的pods, 和template.metadata.labels对应</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 定义pod基础信息</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 给pod打标签</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 定义pod内容</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名为nginx</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2 <span class="token comment"># 容器image为</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上配置文件可以分为二个部分</p><ol><li>第一部分 deployment 元信息</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 定义controller基本信息</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment <span class="token comment"># controller 唯一名称</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 定义controller 内容</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 3个pod副本</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># controller查找管理的pods, 和template.metadata.labels对应</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 定义pod基础信息</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>第二部分 pod模板</li></ol><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 定义pod基础信息</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 给pod打标签</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 定义pod中container</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="特殊功能" tabindex="-1"><a class="header-anchor" href="#特殊功能" aria-hidden="true">#</a> 特殊功能</h4><h5 id="更新策略" tabindex="-1"><a class="header-anchor" href="#更新策略" aria-hidden="true">#</a> 更新策略</h5><p>重建更新(Recreate):全部删除,一起更新 滚动更新(RollingUpdate):(默认)删一点,更新一点</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span>
    <span class="token key atrule">Recreate/RollingUpdate</span><span class="token punctuation">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="版本回退" tabindex="-1"><a class="header-anchor" href="#版本回退" aria-hidden="true">#</a> 版本回退</h5><p>每次更新时, 保存ReplicaSet, 如果想要看到详细的迭代信息需要使用<code>kubectl create -f [YAML_PATH] --record</code></p><p><code>kubectl rollout</code>用来控制升级</p><ul><li>status 显示升级状态 <code>kubectl rollout status deployment web</code> 查看升级状态</li><li>history 历史记录 查看历史版本<code>kubectl rollout history deployment web</code></li><li>undo 回滚到上一个版本 回滚到上一个版本<code>kubectl rollout undo deployment web</code></li><li>金丝雀发布 更新一部分pod, 暂停看效果, 好的话继续, 不好就回退 <ul><li>pause <code>kubectl rollout pause deployment [NAME]</code></li><li>resume <code>kubectl rollout resume deployment [NAME]</code></li><li>restart</li></ul></li></ul><h3 id="horizontal-pod-autoscaler-hpa" tabindex="-1"><a class="header-anchor" href="#horizontal-pod-autoscaler-hpa" aria-hidden="true">#</a> Horizontal Pod Autoscaler(HPA)</h3><p>根据定义的指标, 来动态scale</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> auto
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 最少1个</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># 最大10个</span>
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 3% Cpu使用率超3%则增容</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span> <span class="token comment"># 调整的对象</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment 
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="daemonset" tabindex="-1"><a class="header-anchor" href="#daemonset" aria-hidden="true">#</a> DaemonSet</h3><p>用于节点日志收集和节点监控</p><ul><li>每当添加一个Node,自动添加pod DaemonSet 确保全部（或者某些）节点上运行一个Pod的副本。</li><li>如果指定了<code>.spec.template.spec.nodeSelector</code>则在匹配的节点上创建 Pod。</li><li>如果指定了<code>.spec.template.spec.affinity</code>, 将在能够与节点亲和性匹配的节点上创建 Pod。</li><li>如果根本就没有指定，则 DaemonSet Controller 将在所有节点上创建 Pod。</li></ul><h3 id="statefulsets" tabindex="-1"><a class="header-anchor" href="#statefulsets" aria-hidden="true">#</a> StatefulSets</h3><p>Deployment不同的是，StatefulSet 为每个Pod维护了一个有粘性的ID 每个pod都是独立, 保持pod的启动顺序和唯一网络标识符, 持久存储 sts.yml</p>`,38),p=[t];function c(o,i){return a(),s("div",null,p)}const r=n(l,[["render",c],["__file","k8sController.html.vue"]]);export{r as default};
